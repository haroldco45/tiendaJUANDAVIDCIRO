<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA TIENDA JUAN DAVID CIRO - V12</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a252f; --ingreso: #27ae60; --egreso: #e74c3c; --info: #2980b9; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .caja-negra { background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 5px; }
        .caja-negra h1 { font-size: 2.8rem; margin: 5px 0; color: #fff; }
        .dato-credito { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 0 0 10px 10px; text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid #bbdefb; }
        .seccion { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        label { display: block; font-weight: bold; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; margin-bottom: 10px; }
        .btn { border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; transition: 0.3s; }
        .btn-guardar { background: var(--ingreso); color: white; }
        .btn-wa { background: #25D366; color: white; margin-top: 10px; font-size: 1.1rem; }
        .btn-reporte { background: var(--info); color: white; }
        .item-historial { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .tabla-resumen { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .tabla-resumen th, .tabla-resumen td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9rem; }
        .tabla-resumen th { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--primary); margin-bottom: 10px;">TIENDA JUAN DAVID CIRO</h2>

    <div class="caja-negra">
        <small>EFECTIVO EN CAJA (REAL)</small>
        <h1 id="txtSaldoCaja">$ 0</h1>
    </div>
    <div class="dato-credito" id="txtSoloCredito">Ventas a Cr√©dito Hoy: $ 0</div>

    <div class="seccion">
        <label>FECHA OPERACI√ìN:</label>
        <input type="date" id="fechaOp" onchange="render()">
        
        <label>NUEVA CATEGOR√çA:</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="nuevaSub" placeholder="Ej: QUESOS...">
            <button onclick="agregarCategoria()" style="width:60px; background:var(--primary); color:white; border-radius:8px; border:none;">+</button>
        </div>
    </div>

    <div class="seccion">
        <input type="hidden" id="editId">
        <label>TIPO Y CATEGOR√çA:</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <select id="tipoGen">
                <option value="INGRESO">INGRESO</option>
                <option value="EGRESO">EGRESO</option>
            </select>
            <select id="selSub"></select>
        </div>

        <label>VALOR ($):</label>
        <input type="number" id="txtValor" placeholder="0">

        <label>DETALLE:</label>
        <input type="text" id="txtDetalle">

        <button class="btn btn-guardar" id="btnAccion" onclick="guardar()">REGISTRAR MOVIMIENTO</button>
        <button id="btnCancel" style="display:none; margin-top:5px; background:#95a5a6; color:white; border:none; padding:10px; width:100%; border-radius:8px;" onclick="cancelarEdit()">Cancelar</button>
    </div>

    <div class="seccion" style="background: #fdfefe; border: 2px solid #3498db;">
        <h3 style="margin-top:0; color:#2980b9;">üìä INFORME POR RANGO</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="date" id="repDesde">
            <input type="date" id="repHasta">
        </div>
        <button class="btn btn-reporte" onclick="generarConsolidado()">VER TABLA DE TOTALES</button>
        <div id="resReporte"></div>
        <div id="btnContenedorWA"></div>
    </div>

    <h3>Movimientos del D√≠a</h3>
    <div id="listaD√≠a"></div>

    <button class="btn btn-wa" onclick="enviarWA('diario')">üöÄ ENVIAR CIERRE DIARIO AL WHATSAPP</button>
</div>

<script>
    let movs = JSON.parse(localStorage.getItem('tienda_v12')) || [];
    let categorias = JSON.parse(localStorage.getItem('cats_v12')) || ["VENTA CONTADO", "VENTA CREDITO", "PAGO PROVEEDOR", "GASTOS VARIOS"];

    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fechaOp').value = hoy;
    document.getElementById('repDesde').value = hoy;
    document.getElementById('repHasta').value = hoy;

    function agregarCategoria() {
        const n = document.getElementById('nuevaSub').value.toUpperCase().trim();
        if(n && !categorias.includes(n)) {
            categorias.push(n);
            localStorage.setItem('cats_v12', JSON.stringify(categorias));
            document.getElementById('nuevaSub').value = "";
            poblarCats();
        }
    }

    function poblarCats() {
        const s = document.getElementById('selSub');
        s.innerHTML = "";
        categorias.sort().forEach(x => s.innerHTML += `<option value="${x}">${x}</option>`);
    }

    function guardar() {
        const v = parseFloat(document.getElementById('txtValor').value);
        const id = document.getElementById('editId').value;
        if(!v) return alert("Ingrese un valor");

        const reg = {
            id: id ? parseInt(id) : Date.now(),
            fecha: document.getElementById('fechaOp').value,
            tipo: document.getElementById('tipoGen').value,
            sub: document.getElementById('selSub').value,
            detalle: document.getElementById('txtDetalle').value || "Sin detalle",
            valor: v
        };

        if(id) movs = movs.map(m => m.id === reg.id ? reg : m);
        else movs.push(reg);

        localStorage.setItem('tienda_v12', JSON.stringify(movs));
        cancelarEdit();
        render();
    }

    function prepararEdit(id) {
        const m = movs.find(x => x.id === id);
        document.getElementById('editId').value = m.id;
        document.getElementById('tipoGen').value = m.tipo;
        document.getElementById('selSub').value = m.sub;
        document.getElementById('txtDetalle').value = m.detalle;
        document.getElementById('txtValor').value = m.valor;
        document.getElementById('btnAccion').innerText = "ACTUALIZAR REGISTRO";
        document.getElementById('btnCancel').style.display = "block";
    }

    function cancelarEdit() {
        document.getElementById('editId').value = "";
        document.getElementById('txtValor').value = "";
        document.getElementById('txtDetalle').value = "";
        document.getElementById('btnAccion').innerText = "REGISTRAR MOVIMIENTO";
        document.getElementById('btnCancel').style.display = "none";
    }

    function borrar(id) {
        if(confirm("¬øEliminar?")) {
            movs = movs.filter(m => m.id !== id);
            localStorage.setItem('tienda_v12', JSON.stringify(movs));
            render();
        }
    }

    function render() {
        const f = document.getElementById('fechaOp').value;
        const lista = document.getElementById('listaD√≠a');
        lista.innerHTML = "";
        let caja = 0; let cred = 0;

        movs.filter(m => m.fecha === f).forEach(m => {
            if(m.sub === "VENTA CREDITO") cred += m.valor;
            else {
                if(m.tipo === "INGRESO") caja += m.valor;
                else caja -= m.valor;
            }
            lista.innerHTML += `<div class="item-historial">
                <div><b>${m.sub}</b><br><small>${m.detalle}</small></div>
                <div style="text-align:right"><b style="color:${m.tipo==='INGRESO'?'green':'red'}">${m.tipo==='INGRESO'?'+':'-'} $${m.valor.toLocaleString()}</b><br>
                <span onclick="prepararEdit(${m.id})" style="cursor:pointer">‚úèÔ∏è</span> <span onclick="borrar(${m.id})" style="color:red; cursor:pointer; margin-left:10px;">üóëÔ∏è</span></div>
            </div>`;
        });
        document.getElementById('txtSaldoCaja').innerText = `$ ${caja.toLocaleString()}`;
        document.getElementById('txtSoloCredito').innerText = `Ventas a Cr√©dito Hoy: $ ${cred.toLocaleString()}`;
    }

    function generarConsolidado() {
        const d = document.getElementById('repDesde').value;
        const h = document.getElementById('repHasta').value;
        let res = {};
        
        movs.filter(m => m.fecha >= d && m.fecha <= h).forEach(m => {
            if(!res[m.sub]) res[m.sub] = 0;
            res[m.sub] += (m.tipo === "INGRESO" ? m.valor : -m.valor);
        });

        let tabla = `<table class="tabla-resumen"><tr><th>Categor√≠a</th><th>Total Neto</th></tr>`;
        for(let s in res) {
            tabla += `<tr><td>${s}</td><td>$ ${res[s].toLocaleString()}</td></tr>`;
        }
        document.getElementById('resReporte').innerHTML = tabla + `</table>`;
        
        // Mostrar bot√≥n de WhatsApp Consolidado
        document.getElementById('btnContenedorWA').innerHTML = `
            <button class="btn btn-wa" style="background:#075e54;" onclick="enviarWA('consolidado')">
                üì≤ ENVIAR ESTE CONSOLIDADO AL CELULAR
            </button>`;
    }

    function enviarWA(modo) {
        let msg = "";
        if(modo === 'diario') {
            const f = document.getElementById('fechaOp').value;
            const caja = document.getElementById('txtSaldoCaja').innerText;
            const cred = document.getElementById('txtSoloCredito').innerText;
            let det = "";
            let t = {};
            movs.filter(m => m.fecha === f).forEach(m => { t[m.sub] = (t[m.sub] || 0) + (m.tipo === "INGRESO" ? m.valor : -m.valor); });
            for(let c in t) { det += `‚Ä¢ ${c}: $${t[c].toLocaleString()}\n`; }
            msg = `*CIERRE DIARIO*\nFecha: ${f}\n*EFECTIVO CAJA: ${caja}*\n*${cred}*\n\n*DETALLE:*\n${det}`;
        } else {
            const d = document.getElementById('repDesde').value;
            const h = document.getElementById('repHasta').value;
            let res = {};
            movs.filter(m => m.fecha >= d && m.fecha <= h).forEach(m => {
                if(!res[m.sub]) res[m.sub] = 0;
                res[m.sub] += (m.tipo === "INGRESO" ? m.valor : -m.valor);
            });
            let det = "";
            for(let s in res) { det += `‚Ä¢ ${s}: $${res[s].toLocaleString()}\n`; }
            msg = `*REPORTE CONSOLIDADO*\nDesde: ${d}\nHasta: ${h}\n\n*TOTALES POR CATEGOR√çA:*\n${det}`;
        }
        window.open(`https://api.whatsapp.com/send?phone=573117700431&text=${encodeURIComponent(msg)}`);
    }

    poblarCats();
    render();
</script>
</body>
</html>
